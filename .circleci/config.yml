  version: 2
  jobs:
    build:
      working_directory: ~/repo
      docker:
        - image: cimg/node:12.16
      steps:
        - checkout
        - run:
            name: update-npm
            command: "sudo npm install -g npm@5"
        - restore_cache:
            key: dependency-cache-{{ checksum "package-lock.json" }}
        - run:
            name: install-packages
            command: npm install
        - save_cache:
            key: dependency-cache-{{ checksum "package-lock.json" }}
            paths:
              - ./node_modules
        - run:
            name: test
            command: npm run test
    deploy:
      machine:
        enabled: true
      steps:
        - add_ssh_keys:
            fingerprints:
              - "$DEV_SSH_KEY_FINGERPRINT"
        - run:
            name: Deploy over SSH
            command: |
              ssh $SSH_USER@$DEV_HOST "cd ./phonefreak || git pull origin master || npm run-script build || serve -s build"
  workflows:
   version: 2
   build-and-deploy:
     jobs:
       - build
       - deploy:
           requires:
             - build # only deploy once build job has completed
           filters:
             branches:
               only: master # only deploy on the master branch